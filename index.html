<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High School Baseball Tournament Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .button-group {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 25px;
        }

        #map {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .teams-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .teams-list h3 {
            margin-bottom: 20px;
            color: #374151;
            font-size: 1.3rem;
        }

        .team-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }

        .team-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .team-item.flagged {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .team-name {
            font-weight: 600;
            color: #374151;
            font-size: 1.1rem;
        }

        .age-badge {
            background: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .team-details {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .tournament-name {
            font-weight: 500;
            color: #1e3a8a;
            margin-bottom: 4px;
        }

        .alert {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        .flagged-locations {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .flagged-item {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .flagged-header {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flagged-details {
            color: #78350f;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #1e3a8a;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-group {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            #map {
                height: 400px;
            }
            
            .tabs {
                flex-direction: column;
            }

            .team-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>⚾ High School Baseball Tournament Tracker</h1>
            <p>Track your teams across tournaments with interactive mapping</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'mapView')">📍 Tournament Map</button>
            <button class="tab" onclick="switchTab(event, 'flaggedView')">⚠️ Locations Need Input</button>
        </div>

        <div id="mapView" class="tab-content active">
            <div class="info-box">
                <strong>Live Data:</strong> This app is connected to your Google Sheets and will automatically load the latest tournament schedule. Click "Load Schedule" to refresh data.
            </div>

            <div class="controls">
                <div class="control-group">
                    <div class="input-group">
                        <label for="ageFilter">Filter by Age Group</label>
                        <select id="ageFilter">
                            <option value="">All Age Groups</option>
                            <option value="15u">15u</option>
                            <option value="16u">16u</option>
                            <option value="17u">17u</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="monthFilter">Filter by Month</label>
                        <select id="monthFilter">
                            <option value="">All Months</option>
                            <option value="5">May</option>
                            <option value="6">June</option>
                            <option value="7">July</option>
                            <option value="8">August</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="searchTeam">Search Coach/Tournament</label>
                        <input type="text" id="searchTeam" placeholder="Enter coach name or tournament">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadData()">Load Schedule</button>
                    <button class="btn btn-secondary" onclick="clearFilters()">Clear Filters</button>
                    <button class="btn btn-secondary" onclick="refreshMap()">Refresh Map</button>
                </div>
            </div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalTournaments">0</div>
                    <div class="stat-label">Total Tournaments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueLocations">0</div>
                    <div class="stat-label">Tournament Locations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="flaggedCount">0</div>
                    <div class="stat-label">Need Location Input</div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="teams-list">
                <h3>Tournament Schedule</h3>
                <div id="tournamentsList"></div>
            </div>
        </div>

        <div id="flaggedView" class="tab-content">
            <div class="alert">
                <span class="alert-icon">⚠️</span>
                <div>
                    <strong>Coach Input Needed:</strong> The following tournaments have unclear locations that need to be specified by coaches.
                </div>
            </div>
            <div class="flagged-locations">
                <h3>Tournaments Requiring Location Clarification</h3>
                <div id="flaggedList"></div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let markers = [];
        let tournamentsData = [];
        let filteredData = [];
        let flaggedData = [];

        // Sample data based on your CSV structure
        const sampleTournamentData = [
            {
                age: "16u",
                team: "Evans",
                date: "5/30",
                tournament: "Primetime",
                location: "McHenry, IL",
                lat: 42.3331,
                lng: -88.2668
            },
            {
                age: "16u",
                team: "Hubert",
                date: "6/5",
                tournament: "JP Sports Cobras for a Cause",
                location: "McHenry, IL",
                lat: 42.3331,
                lng: -88.2668
            },
            {
                age: "17u",
                team: "Ankney",
                date: "6/5",
                tournament: "Perfect Game Midwest Championship",
                location: "Marion, IA",
                lat: 42.0347,
                lng: -91.5968
            },
            {
                age: "16u",
                team: "Fraus",
                date: "6/5",
                tournament: "Primetime HS TOC",
                location: "Joliet, IL",
                lat: 41.5250,
                lng: -88.0817
            },
            {
                age: "17u",
                team: "Krebs",
                date: "6/5",
                tournament: "Seminole Home Run Classic",
                location: "Elgin, IL",
                lat: 42.0354,
                lng: -88.2826
            },
            {
                age: "15u",
                team: "Martinez",
                date: "6/12",
                tournament: "PBR Rock Summer Championship",
                location: "Franklin, WI",
                lat: 42.8858,
                lng: -88.0387
            },
            {
                age: "16u",
                team: "Johnson",
                date: "6/19",
                tournament: "Primetime Futures",
                location: "Crystal Lake, IL",
                lat: 42.2411,
                lng: -88.2162
            },
            {
                age: "17u",
                team: "Wilson",
                date: "6/26",
                tournament: "PG Great Lakes Championships",
                location: "West Chicago, IL",
                lat: 41.8847,
                lng: -88.2040
            },
            {
                age: "15u",
                team: "Brown",
                date: "7/3",
                tournament: "Seminole HS Hustle",
                location: "Wheeling, IL",
                lat: 42.1392,
                lng: -87.9290
            },
            {
                age: "16u",
                team: "Davis",
                date: "7/10",
                tournament: "PBR Lakepoint Championship",
                location: "LakePoint Sports Complex, GA",
                lat: 34.1014,
                lng: -84.6755
            },
            {
                age: "17u",
                team: "Miller",
                date: "7/17",
                tournament: "Kansas City Summer Classic",
                location: "Kansas City, MO",
                lat: 39.0997,
                lng: -94.5786
            },
            {
                age: "15u",
                team: "Garcia",
                date: "7/24",
                tournament: "Louisville Derby Tournament",
                location: "Louisville, KY",
                lat: 38.2527,
                lng: -85.7585
            }
        ];

        // Sample flagged data
        const sampleFlaggedData = [
            {
                Age: "16u",
                Team: "Thompson",
                Start_1: "6/8",
                Opponent: "Mystery Tournament",
                Location: "?"
            },
            {
                Age: "17u",
                Team: "Anderson",
                Start_1: "6/15",
                Opponent: "Local Championship",
                Location: "Various"
            },
            {
                Age: "15u",
                Team: "Rodriguez",
                Start_1: "6/22",
                Opponent: "Community Cup",
                Location: "Local"
            }
        ];

        // Initialize map
        function initMap() {
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded');
                document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; flex-direction: column;"><div style="font-size: 1.2rem; margin-bottom: 10px;">🗺️</div><div>Map loading...</div></div>';
                return;
            }

            map = L.map('map').setView([41.8781, -87.6298], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Load data from Google Sheets
        async function loadData() {
            console.log('Loading data from Google Sheets...');
            showLoading();
            
            try {
                // Your Google Sheet ID
                const sheetId = '1_f1JKSRFNjTrNFBWRW9hYUllgVlezOzHoedxzDWOnys';
                const gid = '473783352'; // Your specific sheet tab
                
                // Convert to CSV export URL
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                console.log('Fetching from URL:', csvUrl);
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to fetch data from Google Sheets`);
                }

                const csvText = await response.text();
                console.log('CSV data received, length:', csvText.length);
                
                const parsedData = parseCSV(csvText);
                console.log('Parsed data entries:', parsedData.length);
                
                // Filter out NPU Practice and process tournament data
                const tournamentEntries = parsedData.filter(row => 
                    row.Opponent && !row.Opponent.includes('NPU Practice') && row.Opponent.trim() !== ''
                );
                console.log('Tournament entries (excluding NPU Practice):', tournamentEntries.length);

                // Separate flagged and regular tournaments
                flaggedData = tournamentEntries.filter(row => 
                    flaggedLocations.includes(row.Location)
                );
                console.log('Flagged entries:', flaggedData.length);

                const regularTournaments = tournamentEntries.filter(row => 
                    !flaggedLocations.includes(row.Location)
                );
                console.log('Regular tournaments:', regularTournaments.length);

                // Process regular tournaments
                tournamentsData = regularTournaments.map(row => {
                    let location = row.Location || '';
                    
                    // Apply location mappings
                    if (locationMappings[location]) {
                        location = locationMappings[location];
                    }

                    // Get coordinates
                    const coords = getCoordinates(location);

                    return {
                        age: row.Age || '',
                        team: row.Team || '',
                        date: row.Start_1 || '',
                        endDate: row.End_1 || '',
                        tournament: row.Opponent || '',
                        location: location,
                        originalLocation: row.Location || '',
                        time: row.Time || '',
                        lat: coords.lat,
                        lng: coords.lng
                    };
                });

                filteredData = [...tournamentsData];
                console.log('Processed tournaments:', tournamentsData.length);
                
                updateDisplay();
                hideLoading();
                
                showError(`Successfully loaded ${tournamentsData.length} tournaments and ${flaggedData.length} flagged entries!`, 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                hideLoading();
                showError('Error loading Google Sheets data: ' + error.message + '. Check console for details.');
                
                // Don't fallback to sample data, let user know there's an issue
            }
        }

        // Filter data
        function filterData() {
            const ageFilter = document.getElementById('ageFilter').value;
            const monthFilter = document.getElementById('monthFilter').value;
            const searchTerm = document.getElementById('searchTeam').value.toLowerCase();

            filteredData = tournamentsData.filter(tournament => {
                const matchesAge = !ageFilter || tournament.age === ageFilter;
                
                let matchesMonth = true;
                if (monthFilter && tournament.date) {
                    const dateMonth = tournament.date.split('/')[0];
                    matchesMonth = dateMonth === monthFilter;
                }

                const matchesSearch = !searchTerm || 
                    tournament.team.toLowerCase().includes(searchTerm) ||
                    tournament.tournament.toLowerCase().includes(searchTerm) ||
                    tournament.location.toLowerCase().includes(searchTerm);

                return matchesAge && matchesMonth && matchesSearch;
            });

            updateDisplay();
        }

        // Clear filters
        function clearFilters() {
            document.getElementById('ageFilter').value = '';
            document.getElementById('monthFilter').value = '';
            document.getElementById('searchTeam').value = '';
            filteredData = [...tournamentsData];
            updateDisplay();
        }

        // Refresh map
        function refreshMap() {
            if (map) {
                updateMapMarkers();
            }
        }

        // Switch tabs
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Update display
        function updateDisplay() {
            updateStats();
            updateMapMarkers();
            updateTournamentsList();
            updateFlaggedList();
        }

        // Update statistics
        function updateStats() {
            const uniqueLocations = new Set(filteredData.map(t => t.location)).size;
            
            document.getElementById('totalTournaments').textContent = filteredData.length;
            document.getElementById('uniqueLocations').textContent = uniqueLocations;
            document.getElementById('flaggedCount').textContent = flaggedData.length;
        }

        // Update map markers
        function updateMapMarkers() {
            if (!map) return;

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Group tournaments by location for better display
            const locationGroups = {};
            filteredData.forEach(tournament => {
                const key = `${tournament.lat},${tournament.lng}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = {
                        location: tournament.location,
                        lat: tournament.lat,
                        lng: tournament.lng,
                        tournaments: []
                    };
                }
                locationGroups[key].tournaments.push(tournament);
            });

            // Add markers for each location group
            Object.values(locationGroups).forEach(group => {
                const marker = L.marker([group.lat, group.lng]).addTo(map);
                
                const popupContent = `
                    <div style="font-family: Inter, sans-serif; max-width: 250px;">
                        <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">${group.location}</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${group.tournaments.map(t => `
                                <div style="margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-weight: 600; color: #374151;">Coach ${t.team} (${t.age})</div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">${t.tournament}</div>
                                    <div style="font-size: 0.8rem; color: #9ca3af;">📅 ${t.date}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Update tournaments list
        function updateTournamentsList() {
            const tournamentsList = document.getElementById('tournamentsList');
            
            if (filteredData.length === 0) {
                tournamentsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No tournaments found matching your criteria.</p>';
                return;
            }

            // Sort by date
            const sortedData = [...filteredData].sort((a, b) => {
                if (!a.date || !b.date) return 0;
                const [monthA, dayA] = a.date.split('/').map(Number);
                const [monthB, dayB] = b.date.split('/').map(Number);
                return monthA !== monthB ? monthA - monthB : dayA - dayB;
            });

            const tournamentsHTML = sortedData.map(tournament => `
                <div class="team-item">
                    <div class="team-header">
                        <div class="team-name">Coach ${tournament.team}</div>
                        <div class="age-badge">${tournament.age}</div>
                    </div>
                    <div class="tournament-name">${tournament.tournament}</div>
                    <div class="team-details">
                        📍 ${tournament.location}<br>
                        📅 ${tournament.date}
                    </div>
                </div>
            `).join('');

            tournamentsList.innerHTML = tournamentsHTML;
        }

        // Update flagged locations list
        function updateFlaggedList() {
            const flaggedList = document.getElementById('flaggedList');
            
            if (flaggedData.length === 0) {
                flaggedList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">All locations have been clarified! 🎉</p>';
                return;
            }

            const flaggedHTML = flaggedData.map(item => `
                <div class="flagged-item">
                    <div class="flagged-header">
                        <span>⚠️</span>
                        Coach ${item.Team} (${item.Age}) - ${item.Opponent}
                    </div>
                    <div class="flagged-details">
                        <strong>Current Location:</strong> "${item.Location}"<br>
                        <strong>Date:</strong> ${item.Start_1}<br>
                        <strong>Action Needed:</strong> Please specify the exact location for this tournament
                    </div>
                </div>
            `).join('');

            flaggedList.innerHTML = flaggedHTML;
        }

        // Initialize the app
        window.addEventListener('load', function() {
            // Wait for Leaflet to load
            setTimeout(() => {
                initMap();
                // Don't auto-load data, wait for user to click "Load Schedule"
                
                // Set up event listeners
                document.getElementById('ageFilter').addEventListener('change', filterData);
                document.getElementById('monthFilter').addEventListener('change', filterData);
                document.getElementById('searchTeam').addEventListener('input', filterData);
            }, 100);
        });
    </script>
</body>
</html>
