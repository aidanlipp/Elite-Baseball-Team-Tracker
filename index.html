<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>High School Baseball Tournament Tracker</title>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.css" />
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'Inter', sans-serif;
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 50%, #06b6d4 100%);
            min-height: 100vh;
            color: #333;
        }

        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 20px;
        }

        .header {
            text-align: center;
            margin-bottom: 30px;
            color: white;
        }

        .header h1 {
            font-size: 2.5rem;
            font-weight: 700;
            margin-bottom: 10px;
            text-shadow: 0 2px 4px rgba(0,0,0,0.3);
        }

        .header p {
            font-size: 1.1rem;
            opacity: 0.9;
        }

        .tabs {
            display: flex;
            background: rgba(255, 255, 255, 0.1);
            border-radius: 15px;
            padding: 5px;
            margin-bottom: 25px;
            backdrop-filter: blur(10px);
        }

        .tab {
            flex: 1;
            padding: 12px 20px;
            text-align: center;
            border-radius: 10px;
            cursor: pointer;
            color: white;
            font-weight: 500;
            transition: all 0.3s ease;
            border: none;
            background: transparent;
        }

        .tab.active {
            background: rgba(255, 255, 255, 0.2);
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .tab:hover:not(.active) {
            background: rgba(255, 255, 255, 0.1);
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        .controls {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            margin-bottom: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .control-group {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 20px;
        }

        .input-group {
            display: flex;
            flex-direction: column;
        }

        .input-group label {
            font-weight: 600;
            margin-bottom: 8px;
            color: #374151;
            font-size: 0.9rem;
        }

        .input-group input, .input-group select {
            padding: 12px 16px;
            border: 2px solid #e5e7eb;
            border-radius: 12px;
            font-size: 1rem;
            transition: all 0.3s ease;
            background: white;
        }

        .input-group input:focus, .input-group select:focus {
            outline: none;
            border-color: #3b82f6;
            box-shadow: 0 0 0 3px rgba(59, 130, 246, 0.1);
        }

        .btn {
            padding: 12px 24px;
            border: none;
            border-radius: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s ease;
            font-size: 1rem;
        }

        .btn-primary {
            background: linear-gradient(135deg, #1e3a8a 0%, #3b82f6 100%);
            color: white;
        }

        .btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 8px 25px rgba(59, 130, 246, 0.3);
        }

        .btn-secondary {
            background: #f3f4f6;
            color: #374151;
        }

        .btn-secondary:hover {
            background: #e5e7eb;
        }

        .button-group {
            display: flex;
            gap: 15px;
            align-items: end;
            flex-wrap: wrap;
        }

        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 25px;
        }

        .stat-card {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .stat-number {
            font-size: 2rem;
            font-weight: 700;
            color: #1e3a8a;
            margin-bottom: 5px;
        }

        .stat-label {
            color: #6b7280;
            font-weight: 500;
        }

        .map-container {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 20px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
            margin-bottom: 25px;
        }

        #map {
            height: 500px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }

        .teams-list {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .teams-list h3 {
            margin-bottom: 20px;
            color: #374151;
            font-size: 1.3rem;
        }

        .team-item {
            background: white;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 10px;
            box-shadow: 0 2px 8px rgba(0,0,0,0.05);
            transition: all 0.3s ease;
            border-left: 4px solid #3b82f6;
        }

        .team-item:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(0,0,0,0.1);
        }

        .team-item.flagged {
            border-left-color: #f59e0b;
            background: #fef3c7;
        }

        .team-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 8px;
        }

        .team-name {
            font-weight: 600;
            color: #374151;
            font-size: 1.1rem;
        }

        .age-badge {
            background: #3b82f6;
            color: white;
            padding: 4px 8px;
            border-radius: 6px;
            font-size: 0.8rem;
            font-weight: 500;
        }

        .team-details {
            color: #6b7280;
            font-size: 0.9rem;
            line-height: 1.4;
        }

        .tournament-name {
            font-weight: 500;
            color: #1e3a8a;
            margin-bottom: 4px;
        }

        .alert {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            color: #92400e;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            display: flex;
            align-items: center;
            gap: 10px;
        }

        .alert-icon {
            font-size: 1.2rem;
        }

        .flagged-locations {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            border-radius: 20px;
            padding: 25px;
            box-shadow: 0 8px 32px rgba(0,0,0,0.1);
            border: 1px solid rgba(255,255,255,0.2);
        }

        .flagged-item {
            background: #fef3c7;
            border: 1px solid #f59e0b;
            border-radius: 12px;
            padding: 15px;
            margin-bottom: 15px;
        }

        .flagged-header {
            font-weight: 600;
            color: #92400e;
            margin-bottom: 8px;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .flagged-details {
            color: #78350f;
            font-size: 0.9rem;
        }

        .loading {
            text-align: center;
            padding: 40px;
            color: #6b7280;
        }

        .spinner {
            display: inline-block;
            width: 30px;
            height: 30px;
            border: 3px solid #f3f4f6;
            border-top: 3px solid #3b82f6;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .info-box {
            background: rgba(59, 130, 246, 0.1);
            border: 1px solid #3b82f6;
            color: #1e3a8a;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .success-box {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #065f46;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
        }

        .active-date-info {
            background: rgba(16, 185, 129, 0.1);
            border: 1px solid #10b981;
            color: #065f46;
            padding: 15px;
            border-radius: 12px;
            margin-bottom: 20px;
            font-weight: 500;
        }

        @media (max-width: 768px) {
            .container {
                padding: 15px;
            }
            
            .header h1 {
                font-size: 2rem;
            }
            
            .control-group {
                grid-template-columns: 1fr;
            }
            
            .button-group {
                flex-direction: column;
            }
            
            #map {
                height: 400px;
            }
            
            .tabs {
                flex-direction: column;
            }

            .team-header {
                flex-direction: column;
                align-items: flex-start;
                gap: 8px;
            }
        }
    </style>
</head>
<body>
    <div class="container">
        <div class="header">
            <h1>‚öæ High School Baseball Tournament Tracker</h1>
            <p>Track your teams across tournaments with interactive mapping</p>
        </div>

        <div class="tabs">
            <button class="tab active" onclick="switchTab(event, 'mapView')">üìç Tournament Map</button>
            <button class="tab" onclick="switchTab(event, 'flaggedView')">‚ö†Ô∏è Locations Need Input</button>
        </div>

        <div id="mapView" class="tab-content active">
            <div class="info-box">
                <strong>Live Data:</strong> This app is connected to your Google Sheets and will automatically load the latest tournament schedule. Click "Load Schedule" to refresh data.
            </div>

            <div class="controls">
                <div class="control-group">
                    <div class="input-group">
                        <label for="ageFilter">Filter by Age Group</label>
                        <select id="ageFilter">
                            <option value="">All Age Groups</option>
                            <option value="15u">15u</option>
                            <option value="16u">16u</option>
                            <option value="17u">17u</option>
                        </select>
                    </div>
                    <div class="input-group">
                        <label for="specificDate">Find Teams on Specific Date</label>
                        <input type="date" id="specificDate" onchange="filterBySpecificDate()">
                    </div>
                    <div class="input-group">
                        <label for="quickDateFilter">Quick Date Filters</label>
                        <select id="quickDateFilter" onchange="applyQuickDateFilter()">
                            <option value="">All Dates</option>
                            <option value="today">Today</option>
                            <option value="tomorrow">Tomorrow</option>
                            <option value="thisWeek">This Week</option>
                            <option value="nextWeek">Next Week</option>
                            <option value="thisMonth">This Month</option>
                        </select>
                    </div>
                </div>
                <div class="control-group">
                    <div class="input-group">
                        <label for="searchTeam">Search Coach/Tournament</label>
                        <input type="text" id="searchTeam" placeholder="Enter coach name or tournament">
                    </div>
                </div>
                <div class="button-group">
                    <button class="btn btn-primary" onclick="loadData()">Load Schedule</button>
                    <button class="btn btn-secondary" onclick="clearAllFilters()">Clear All Filters</button>
                    <button class="btn btn-secondary" onclick="refreshMap()">Refresh Map</button>
                </div>
            </div>

            <div id="activeDateInfo"></div>

            <div class="stats">
                <div class="stat-card">
                    <div class="stat-number" id="totalTournaments">0</div>
                    <div class="stat-label">Total Tournaments</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="uniqueLocations">0</div>
                    <div class="stat-label">Tournament Locations</div>
                </div>
                <div class="stat-card">
                    <div class="stat-number" id="flaggedCount">0</div>
                    <div class="stat-label">Need Location Input</div>
                </div>
            </div>

            <div class="map-container">
                <div id="map"></div>
            </div>

            <div class="teams-list">
                <h3>Tournament Schedule</h3>
                <div id="tournamentsList">
                    <p style="text-align: center; color: #6b7280; padding: 20px;">Click "Load Schedule" to load tournament data from Google Sheets.</p>
                </div>
            </div>
        </div>

        <div id="flaggedView" class="tab-content">
            <div class="alert">
                <span class="alert-icon">‚ö†Ô∏è</span>
                <div>
                    <strong>Coach Input Needed:</strong> The following tournaments have unclear locations that need to be specified by coaches.
                </div>
            </div>
            <div class="flagged-locations">
                <h3>Tournaments Requiring Location Clarification</h3>
                <div id="flaggedList">
                    <p style="text-align: center; color: #6b7280; padding: 20px;">Click "Load Schedule" first to see flagged locations.</p>
                </div>
            </div>
        </div>
    </div>

    <script src="https://cdnjs.cloudflare.com/ajax/libs/leaflet/1.9.4/leaflet.min.js"></script>
    <script>
        let map;
        let markers = [];
        let tournamentsData = [];
        let filteredData = [];
        let flaggedData = [];

        // Location mappings based on your specifications
        const locationMappings = {
            'Inwood': 'Joliet, IL',
            'The Rock': 'Franklin, WI',
            'KC': 'Kansas City, MO',
            'KY': 'Louisville, KY',
            'Lakepoint': 'LakePoint Sports Complex, GA'
        };

        // Flagged locations that need coach input
        const flaggedLocations = ['?', 'Various', 'Local', 'Inwood?', 'Lakepoint?', 'The Rock?'];

        // City coordinates for mapping
        const cityCoordinates = {
            'McHenry, IL': { lat: 42.3331, lng: -88.2668 },
            'Marion, IA': { lat: 42.0347, lng: -91.5968 },
            'Joliet, IL': { lat: 41.5250, lng: -88.0817 },
            'Elgin, IL': { lat: 42.0354, lng: -88.2826 },
            'Palos Heights, IL': { lat: 41.6689, lng: -87.7967 },
            'Franklin, WI': { lat: 42.8858, lng: -88.0387 },
            'Kansas City, MO': { lat: 39.0997, lng: -94.5786 },
            'Louisville, KY': { lat: 38.2527, lng: -85.7585 },
            'LakePoint Sports Complex, GA': { lat: 34.1014, lng: -84.6755 },
            'Crystal Lake, IL': { lat: 42.2411, lng: -88.2162 },
            'Rockford, IL': { lat: 42.2711, lng: -89.0940 },
            'West Chicago, IL': { lat: 41.8847, lng: -88.2040 },
            'Kankakee, IL': { lat: 41.1200, lng: -87.8612 },
            'Wisconsin Dells, WI': { lat: 43.6275, lng: -89.7710 },
            'Westfield, IN': { lat: 40.0431, lng: -86.1277 },
            'Wheeling, IL': { lat: 42.1392, lng: -87.9290 },
            'Rantoul, IL': { lat: 40.3084, lng: -88.1559 },
            'Carthage, WI': { lat: 43.0016, lng: -90.1843 },
            'Kenosha, WI': { lat: 42.5847, lng: -87.8212 },
            'Evanston, IL': { lat: 42.0451, lng: -87.6877 },
            'Mauston, WI': { lat: 43.8014, lng: -90.0762 },
            'Pleasant Prairie, WI': { lat: 42.5531, lng: -87.9334 },
            'Bradley, IL': { lat: 41.1420, lng: -87.8612 },
            'New Lenox, IL': { lat: 41.5117, lng: -87.9656 },
            'Gulf Shores, AL': { lat: 30.2460, lng: -87.7008 },
            'Vernon Hills, IL': { lat: 42.2131, lng: -87.9612 },
            'Creekside, MO': { lat: 39.0458, lng: -94.5164 },
            'Chicagoland': { lat: 41.8781, lng: -87.6298 },
            'Various': { lat: 41.8781, lng: -87.6298 },
            'Local': { lat: 41.8781, lng: -87.6298 }
        };

        // UTILITY FUNCTIONS - DEFINED FIRST
        function showLoading() {
            const tournamentsList = document.getElementById('tournamentsList');
            tournamentsList.innerHTML = `
                <div class="loading">
                    <div class="spinner"></div>
                    <p>Loading tournament data from Google Sheets...</p>
                </div>
            `;
        }

        function hideLoading() {
            // Loading will be replaced by updateDisplay
        }

        function showError(message, type = 'error') {
            const container = document.querySelector('.container');
            const existingAlerts = container.querySelectorAll('.alert, .success-box');
            existingAlerts.forEach(alert => alert.remove());
            
            const errorDiv = document.createElement('div');
            errorDiv.className = type === 'success' ? 'success-box' : 'alert';
            errorDiv.innerHTML = type === 'success' ? 
                `<strong>‚úÖ Success:</strong> ${message}` :
                `<span class="alert-icon">‚ùå</span><div>${message}</div>`;
            
            const header = container.querySelector('.header');
            header.insertAdjacentElement('afterend', errorDiv);
            
            setTimeout(() => {
                errorDiv.remove();
            }, type === 'success' ? 5000 : 10000);
        }

        // Parse date in MM/DD format and convert to Date object for current year
        function parseDate(dateStr) {
            if (!dateStr) return null;
            const parts = dateStr.split('/');
            if (parts.length !== 2) return null;
            const month = parseInt(parts[0]) - 1; // JavaScript months are 0-indexed
            const day = parseInt(parts[1]);
            const currentYear = new Date().getFullYear();
            return new Date(currentYear, month, day);
        }

        // Create full tournament date range from Start/Start_2 and End/End_2 columns
        function createTournamentDateRange(row) {
            console.log('Processing row for:', row.Team, 'Available keys:', Object.keys(row)); // Debug log
            
            // The actual date should be in Start_2 (second Start column) like "5/27"
            let startDateStr = '';
            if (row.Start_2 && row.Start_2.trim() !== '' && row.Start_2 !== 'Tu' && row.Start_2 !== 'We' && row.Start_2 !== 'Th' && row.Start_2 !== 'Fr' && row.Start_2 !== 'Sa' && row.Start_2 !== 'Su' && row.Start_2 !== 'Mo') {
                startDateStr = row.Start_2.trim();
                console.log(`Found start date in Start_2:`, startDateStr);
            }

            // The end date should be in End_2 (second End column)
            let endDateStr = '';
            if (row.End_2 && row.End_2.trim() !== '' && row.End_2 !== 'Tu' && row.End_2 !== 'We' && row.End_2 !== 'Th' && row.End_2 !== 'Fr' && row.End_2 !== 'Sa' && row.End_2 !== 'Su' && row.End_2 !== 'Mo') {
                endDateStr = row.End_2.trim();
                console.log(`Found end date in End_2:`, endDateStr);
            } else if (startDateStr) {
                endDateStr = startDateStr; // Single day tournament
            }

            // Convert from M/D format to MM/DD format for consistency
            if (startDateStr && startDateStr.includes('/')) {
                startDateStr = formatDateString(startDateStr);
            }
            if (endDateStr && endDateStr.includes('/')) {
                endDateStr = formatDateString(endDateStr);
            }

            console.log(`Final date range for ${row.Team}: start=${startDateStr}, end=${endDateStr}`); // Debug log

            return {
                startDate: startDateStr,
                endDate: endDateStr,
                displayRange: startDateStr && endDateStr && startDateStr !== endDateStr 
                    ? `${startDateStr} - ${endDateStr}` 
                    : startDateStr || 'No date'
            };
        }

        // Format date string to ensure MM/DD format
        function formatDateString(dateStr) {
            if (!dateStr) return '';
            
            const parts = dateStr.split('/');
            if (parts.length !== 2) return dateStr;
            
            const month = parts[0].padStart(2, '0');
            const day = parts[1].padStart(2, '0');
            
            return `${month}/${day}`;
        }

        // Parse CSV data with better handling for duplicate column names
        function parseCSV(csvText) {
            const lines = csvText.split('\n');
            const rawHeaders = lines[0].split(',').map(h => h.trim());
            
            // Create unique headers by adding _1, _2, etc. for duplicates
            const headers = [];
            const headerCounts = {};
            
            rawHeaders.forEach(header => {
                if (headerCounts[header]) {
                    headerCounts[header]++;
                    headers.push(`${header}_${headerCounts[header]}`);
                } else {
                    headerCounts[header] = 1;
                    headers.push(header);
                }
            });
            
            console.log('Original CSV Headers:', rawHeaders);
            console.log('Processed Headers:', headers);
            
            const data = [];
            for (let i = 1; i < lines.length && i < 5; i++) { // Only log first few rows
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    
                    console.log(`Row ${i} sample:`, {
                        Team: row.Team,
                        Start: row.Start,
                        Start_2: row.Start_2, // This should now contain the actual date
                        End: row.End,
                        End_2: row.End_2, // This should contain the end date
                        Opponent: row.Opponent
                    });
                    
                    data.push(row);
                }
            }
            
            // Continue parsing all rows
            for (let i = 5; i < lines.length; i++) {
                if (lines[i].trim()) {
                    const values = lines[i].split(',');
                    const row = {};
                    headers.forEach((header, index) => {
                        row[header] = values[index] ? values[index].trim() : '';
                    });
                    data.push(row);
                }
            }
            
            console.log('Total rows parsed:', data.length);
            return data;
        }

        // Get coordinates for a location
        function getCoordinates(location) {
            // Direct match
            if (cityCoordinates[location]) {
                return cityCoordinates[location];
            }

            // Partial match
            for (const [city, coords] of Object.entries(cityCoordinates)) {
                if (location.toLowerCase().includes(city.toLowerCase().split(',')[0])) {
                    return coords;
                }
            }

            // Default to Chicago area if not found
            return { lat: 41.8781, lng: -87.6298 };
        }

        // Check if a date falls within a tournament's date range
        function isDateInTournamentRange(checkDate, tournament) {
            if (!checkDate || !tournament.startDate) return false;
            
            const startDate = parseDate(tournament.startDate);
            const endDate = parseDate(tournament.endDate);
            
            if (!startDate) return false;
            if (!endDate) return checkDate.toDateString() === startDate.toDateString();
            
            return checkDate >= startDate && checkDate <= endDate;
        }

        // Initialize map
        function initMap() {
            if (typeof L === 'undefined') {
                console.error('Leaflet library not loaded');
                document.getElementById('map').innerHTML = '<div style="display: flex; align-items: center; justify-content: center; height: 100%; color: #6b7280; flex-direction: column;"><div style="font-size: 1.2rem; margin-bottom: 10px;">üó∫Ô∏è</div><div>Map loading...</div></div>';
                return;
            }

            map = L.map('map').setView([41.8781, -87.6298], 6);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '¬© OpenStreetMap contributors'
            }).addTo(map);
        }

        // Load data from Google Sheets
        async function loadData() {
            console.log('Loading data from Google Sheets...');
            showLoading();
            
            try {
                // Your Google Sheet ID
                const sheetId = '1_f1JKSRFNjTrNFBWRW9hYUllgVlezOzHoedxzDWOnys';
                const gid = '473783352'; // Your specific sheet tab
                
                // Convert to CSV export URL
                const csvUrl = `https://docs.google.com/spreadsheets/d/${sheetId}/export?format=csv&gid=${gid}`;
                console.log('Fetching from URL:', csvUrl);
                
                const response = await fetch(csvUrl);
                if (!response.ok) {
                    throw new Error(`HTTP ${response.status}: Failed to fetch data from Google Sheets`);
                }

                const csvText = await response.text();
                console.log('CSV data received, length:', csvText.length);
                
                const parsedData = parseCSV(csvText);
                console.log('Parsed data entries:', parsedData.length);
                
                // Filter out NPU Practice and process tournament data
                const tournamentEntries = parsedData.filter(row => 
                    row.Opponent && !row.Opponent.includes('NPU Practice') && row.Opponent.trim() !== ''
                );
                console.log('Tournament entries (excluding NPU Practice):', tournamentEntries.length);

                // Separate flagged and regular tournaments
                flaggedData = tournamentEntries.filter(row => 
                    flaggedLocations.includes(row.Location)
                );
                console.log('Flagged entries:', flaggedData.length);

                const regularTournaments = tournamentEntries.filter(row => 
                    !flaggedLocations.includes(row.Location)
                );
                console.log('Regular tournaments:', regularTournaments.length);

                // Process regular tournaments
                tournamentsData = regularTournaments.map(row => {
                    let location = row.Location || '';
                    
                    // Apply location mappings
                    if (locationMappings[location]) {
                        location = locationMappings[location];
                    }

                    // Get coordinates
                    const coords = getCoordinates(location);

                    // Create proper date range from Start/Start_1 and End/End_1
                    const dateRange = createTournamentDateRange(row);

                    return {
                        age: row.Age || '',
                        team: row.Team || '',
                        startDate: dateRange.startDate,
                        endDate: dateRange.endDate,
                        dateRange: dateRange.displayRange,
                        tournament: row.Opponent || '',
                        location: location,
                        originalLocation: row.Location || '',
                        time: row.Time || '',
                        lat: coords.lat,
                        lng: coords.lng
                    };
                });

                filteredData = [...tournamentsData];
                console.log('Processed tournaments:', tournamentsData.length);
                
                updateDisplay();
                hideLoading();
                
                showError(`Successfully loaded ${tournamentsData.length} tournaments and ${flaggedData.length} flagged entries!`, 'success');
                
            } catch (error) {
                console.error('Error loading data:', error);
                hideLoading();
                showError('Error loading Google Sheets data: ' + error.message + '. Check console for details.');
            }
        }

        // Filter by specific date
        function filterBySpecificDate() {
            const specificDateStr = document.getElementById('specificDate').value;
            if (!specificDateStr) {
                // If no date selected, apply regular filters
                filterData();
                document.getElementById('activeDateInfo').innerHTML = '';
                return;
            }
            
            console.log('Filtering by specific date:', specificDateStr);
            const specificDate = new Date(specificDateStr);
            console.log('Parsed specific date:', specificDate);
            
            // Filter tournaments that are active on this specific date
            const tournamentsOnDate = tournamentsData.filter(tournament => {
                const isInRange = isDateInTournamentRange(specificDate, tournament);
                console.log(`Tournament ${tournament.team}: ${tournament.dateRange}, In range: ${isInRange}`);
                return isInRange;
            });
            
            console.log('Tournaments found on date:', tournamentsOnDate.length);
            
            // Apply other filters on top of date filter
            const ageFilter = document.getElementById('ageFilter').value;
            const searchTerm = document.getElementById('searchTeam').value.toLowerCase();
            
            filteredData = tournamentsOnDate.filter(tournament => {
                const matchesAge = !ageFilter || tournament.age === ageFilter;
                const matchesSearch = !searchTerm || 
                    tournament.team.toLowerCase().includes(searchTerm) ||
                    tournament.tournament.toLowerCase().includes(searchTerm) ||
                    tournament.location.toLowerCase().includes(searchTerm);
                
                return matchesAge && matchesSearch;
            });
            
            // Show active date info
            const dateOptions = { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' };
            const formattedDate = specificDate.toLocaleDateString('en-US', dateOptions);
            
            document.getElementById('activeDateInfo').innerHTML = `
                <div class="active-date-info">
                    <strong>üìÖ Showing teams competing on ${formattedDate}</strong><br>
                    Found ${filteredData.length} teams at ${new Set(filteredData.map(t => t.location)).size} locations
                </div>
            `;
            
            console.log('Final filtered data:', filteredData.length);
            updateDisplay();
        }

        // Quick date filter options
        function applyQuickDateFilter() {
            const quickFilter = document.getElementById('quickDateFilter').value;
            const today = new Date();
            
            // Clear other date inputs
            document.getElementById('specificDate').value = '';
            document.getElementById('activeDateInfo').innerHTML = '';
            
            let startDate, endDate;
            let filterName = '';
            
            switch(quickFilter) {
                case 'today':
                    startDate = endDate = today;
                    filterName = 'Today';
                    break;
                case 'tomorrow':
                    const tomorrow = new Date(today);
                    tomorrow.setDate(today.getDate() + 1);
                    startDate = endDate = tomorrow;
                    filterName = 'Tomorrow';
                    break;
                case 'thisWeek':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay()); // Start of week (Sunday)
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // End of week (Saturday)
                    filterName = 'This Week';
                    break;
                case 'nextWeek':
                    startDate = new Date(today);
                    startDate.setDate(today.getDate() - today.getDay() + 7); // Start of next week
                    endDate = new Date(startDate);
                    endDate.setDate(startDate.getDate() + 6); // End of next week
                    filterName = 'Next Week';
                    break;
                case 'thisMonth':
                    startDate = new Date(today.getFullYear(), today.getMonth(), 1);
                    endDate = new Date(today.getFullYear(), today.getMonth() + 1, 0);
                    filterName = 'This Month';
                    break;
                default:
                    filterData();
                    return;
            }
            
            // Filter tournaments in the selected period
            filteredData = tournamentsData.filter(tournament => {
                const tournamentStart = parseDate(tournament.startDate);
                const tournamentEnd = parseDate(tournament.endDate);
                
                if (!tournamentStart) return false;
                
                // Check if tournament overlaps with selected period
                const actualEndDate = tournamentEnd || tournamentStart;
                let inRange = tournamentStart <= endDate && actualEndDate >= startDate;
                
                // Apply other filters
                const ageFilter = document.getElementById('ageFilter').value;
                const searchTerm = document.getElementById('searchTeam').value.toLowerCase();
                
                const matchesAge = !ageFilter || tournament.age === ageFilter;
                const matchesSearch = !searchTerm || 
                    tournament.team.toLowerCase().includes(searchTerm) ||
                    tournament.tournament.toLowerCase().includes(searchTerm) ||
                    tournament.location.toLowerCase().includes(searchTerm);
                
                return inRange && matchesAge && matchesSearch;
            });
            
            // Show filter info
            document.getElementById('activeDateInfo').innerHTML = `
                <div class="active-date-info">
                    <strong>üìÖ Showing tournaments for ${filterName}</strong><br>
                    Found ${filteredData.length} teams at ${new Set(filteredData.map(t => t.location)).size} locations
                </div>
            `;
            
            updateDisplay();
        }

        // Filter data
        function filterData() {
            const ageFilter = document.getElementById('ageFilter').value;
            const searchTerm = document.getElementById('searchTeam').value.toLowerCase();

            filteredData = tournamentsData.filter(tournament => {
                const matchesAge = !ageFilter || tournament.age === ageFilter;
                const matchesSearch = !searchTerm || 
                    tournament.team.toLowerCase().includes(searchTerm) ||
                    tournament.tournament.toLowerCase().includes(searchTerm) ||
                    tournament.location.toLowerCase().includes(searchTerm);

                return matchesAge && matchesSearch;
            });

            updateDisplay();
        }

        // Clear all filters
        function clearAllFilters() {
            document.getElementById('ageFilter').value = '';
            document.getElementById('searchTeam').value = '';
            document.getElementById('specificDate').value = '';
            document.getElementById('quickDateFilter').value = '';
            document.getElementById('activeDateInfo').innerHTML = '';
            filteredData = [...tournamentsData];
            updateDisplay();
        }

        // Refresh map
        function refreshMap() {
            if (map) {
                updateMapMarkers();
            }
        }

        // Switch tabs
        function switchTab(event, tabName) {
            document.querySelectorAll('.tab').forEach(tab => tab.classList.remove('active'));
            document.querySelectorAll('.tab-content').forEach(content => content.classList.remove('active'));
            
            event.target.classList.add('active');
            document.getElementById(tabName).classList.add('active');
        }

        // Update display
        function updateDisplay() {
            updateStats();
            updateMapMarkers();
            updateTournamentsList();
            updateFlaggedList();
        }

        // Update statistics
        function updateStats() {
            const uniqueLocations = new Set(filteredData.map(t => t.location)).size;
            
            document.getElementById('totalTournaments').textContent = filteredData.length;
            document.getElementById('uniqueLocations').textContent = uniqueLocations;
            document.getElementById('flaggedCount').textContent = flaggedData.length;
        }

        // Update map markers
        function updateMapMarkers() {
            if (!map) return;

            // Clear existing markers
            markers.forEach(marker => map.removeLayer(marker));
            markers = [];

            // Group tournaments by location for better display
            const locationGroups = {};
            filteredData.forEach(tournament => {
                const key = `${tournament.lat},${tournament.lng}`;
                if (!locationGroups[key]) {
                    locationGroups[key] = {
                        location: tournament.location,
                        lat: tournament.lat,
                        lng: tournament.lng,
                        tournaments: []
                    };
                }
                locationGroups[key].tournaments.push(tournament);
            });

            // Add markers for each location group
            Object.values(locationGroups).forEach(group => {
                const marker = L.marker([group.lat, group.lng]).addTo(map);
                
                const popupContent = `
                    <div style="font-family: Inter, sans-serif; max-width: 250px;">
                        <h4 style="margin: 0 0 10px 0; color: #1e3a8a;">${group.location}</h4>
                        <div style="max-height: 200px; overflow-y: auto;">
                            ${group.tournaments.map(t => `
                                <div style="margin-bottom: 8px; padding: 8px; background: #f8fafc; border-radius: 6px;">
                                    <div style="font-weight: 600; color: #374151;">Coach ${t.team} (${t.age})</div>
                                    <div style="font-size: 0.9rem; color: #6b7280;">${t.tournament}</div>
                                    <div style="font-size: 0.8rem; color: #9ca3af;">üìÖ ${t.dateRange}</div>
                                </div>
                            `).join('')}
                        </div>
                    </div>
                `;
                
                marker.bindPopup(popupContent);
                markers.push(marker);
            });

            // Fit map to show all markers
            if (markers.length > 0) {
                const group = new L.featureGroup(markers);
                map.fitBounds(group.getBounds().pad(0.1));
            }
        }

        // Update tournaments list
        function updateTournamentsList() {
            const tournamentsList = document.getElementById('tournamentsList');
            
            if (filteredData.length === 0) {
                tournamentsList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">No tournaments found matching your criteria.</p>';
                return;
            }

            // Sort by start date
            const sortedData = [...filteredData].sort((a, b) => {
                if (!a.startDate || !b.startDate) return 0;
                const [monthA, dayA] = a.startDate.split('/').map(Number);
                const [monthB, dayB] = b.startDate.split('/').map(Number);
                return monthA !== monthB ? monthA - monthB : dayA - dayB;
            });

            const tournamentsHTML = sortedData.map(tournament => `
                <div class="team-item">
                    <div class="team-header">
                        <div class="team-name">Coach ${tournament.team}</div>
                        <div class="age-badge">${tournament.age}</div>
                    </div>
                    <div class="tournament-name">${tournament.tournament}</div>
                    <div class="team-details">
                        üìç ${tournament.location}<br>
                        üìÖ ${tournament.dateRange}
                        ${tournament.time ? `<br>‚è∞ ${tournament.time}` : ''}
                    </div>
                </div>
            `).join('');

            tournamentsList.innerHTML = tournamentsHTML;
        }

        // Update flagged locations list
        function updateFlaggedList() {
            const flaggedList = document.getElementById('flaggedList');
            
            if (flaggedData.length === 0) {
                flaggedList.innerHTML = '<p style="text-align: center; color: #6b7280; padding: 20px;">All locations have been clarified! üéâ</p>';
                return;
            }

            const flaggedHTML = flaggedData.map(item => `
                <div class="flagged-item">
                    <div class="flagged-header">
                        <span>‚ö†Ô∏è</span>
                        Coach ${item.Team} (${item.Age}) - ${item.Opponent}
                    </div>
                    <div class="flagged-details">
                        <strong>Current Location:</strong> "${item.Location}"<br>
                        <strong>Date:</strong> ${item.Start_1}<br>
                        <strong>Action Needed:</strong> Please specify the exact location for this tournament
                    </div>
                </div>
            `).join('');

            flaggedList.innerHTML = flaggedHTML;
        }

        // Initialize the app
        window.addEventListener('load', function() {
            // Wait for Leaflet to load
            setTimeout(() => {
                initMap();
                
                // Set up event listeners
                document.getElementById('ageFilter').addEventListener('change', filterData);
                document.getElementById('searchTeam').addEventListener('input', filterData);
            }, 100);
        });
    </script>
</body>
</html>
